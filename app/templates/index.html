<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PS2 ISO Importer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <main class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8">
      <header class="rounded-2xl border border-cyan-500/30 bg-gradient-to-r from-cyan-900/40 via-slate-900 to-emerald-900/30 p-6">
        <p class="text-xs uppercase tracking-[0.2em] text-cyan-300">PS2 Tooling</p>
        <h1 class="mt-2 text-3xl font-bold text-white">ISO Import Web Console</h1>
        <p class="mt-2 text-sm text-slate-300">Upload ISO files, set target path, validate structure, and import with strict state handling.</p>
      </header>

      <section class="mt-6 grid gap-6 lg:grid-cols-2">
        <form id="import-form" class="space-y-5 rounded-2xl border border-slate-800 bg-slate-900/80 p-6">
          <div>
            <label for="target-path" class="block text-sm font-medium text-slate-200">Target Parent Folder</label>
            <div class="mt-2 flex gap-2">
              <input
                id="target-path"
                name="target_path"
                type="text"
                placeholder="/Volumes/FLASHDRIVE"
                class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100 outline-none ring-cyan-400 transition focus:ring"
                required
              />
              <button id="pick-folder-btn" type="button" class="rounded-lg bg-slate-700 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-600">Select Folder</button>
            </div>
          </div>

          <div>
            <label for="iso-files" class="block text-sm font-medium text-slate-200">ISO Files</label>
            <input
              id="iso-files"
              name="files"
              type="file"
              accept=".iso"
              multiple
              class="mt-2 block w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-200"
              required
            />
          </div>

          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input id="overwrite" type="checkbox" checked class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-cyan-500 focus:ring-cyan-500" />
            Overwrite existing files
          </label>

          <div class="flex flex-wrap gap-3">
            <button id="validate-btn" type="button" class="rounded-lg bg-cyan-500 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-cyan-400">Validate Target</button>
            <button id="import-btn" type="submit" class="rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-emerald-400">Prepare + Import</button>
            <button id="format-btn" type="button" class="rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-amber-300">Format USB</button>
            <button id="cancel-btn" type="button" class="rounded-lg bg-rose-500 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-rose-400" disabled>Cancel</button>
          </div>
        </form>

        <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">State</h2>
            <span id="state-pill" class="rounded-full border border-slate-600 px-3 py-1 text-xs uppercase tracking-wide text-slate-200">idle</span>
          </div>

          <p id="status-message" class="mt-3 text-sm text-slate-300">Ready.</p>

          <div class="mt-4 h-2 rounded-full bg-slate-800">
            <div id="progress-bar" class="h-2 w-0 rounded-full bg-cyan-400 transition-all duration-300"></div>
          </div>

          <div class="mt-5">
            <h3 class="text-sm font-semibold text-slate-200">Event Log</h3>
            <ul id="event-log" class="mt-2 max-h-80 space-y-2 overflow-auto text-xs text-slate-300"></ul>
          </div>
        </section>
      </section>

      <section class="mt-6 rounded-2xl border border-slate-800 bg-slate-900/80 p-6">
        <h2 class="text-lg font-semibold text-slate-100">Workflow Steps</h2>
        <ol class="mt-3 list-decimal space-y-2 pl-5 text-sm text-slate-300">
          <li><span class="font-semibold text-slate-100">Step 1:</span> กด <span class="rounded bg-slate-800 px-1.5 py-0.5 text-xs">Select Folder</span> เพื่อเลือก target USB</li>
          <li><span class="font-semibold text-slate-100">Step 2:</span> กด <span class="rounded bg-slate-800 px-1.5 py-0.5 text-xs">Validate Target</span> เพื่อตรวจ path และสร้างโฟลเดอร์ให้ครบ</li>
          <li><span class="font-semibold text-slate-100">Step 3:</span> เลือกไฟล์ ISO แล้วกด <span class="rounded bg-slate-800 px-1.5 py-0.5 text-xs">Prepare + Import</span></li>
          <li><span class="font-semibold text-slate-100">Step 4:</span> ระบบจะ import เกมเข้า <code>CD/</code> หรือ <code>DVD/</code>, ดึง <code>game_id</code> จาก ISO (ถ้าอ่านได้), และบันทึก mapping ที่ <code>CFG/game_manifest.json</code></li>
          <li><span class="font-semibold text-slate-100">Step 5:</span> ที่ ART Manager กด <span class="rounded bg-slate-800 px-1.5 py-0.5 text-xs">Search ART</span> แล้วเลือกรูป</li>
          <li><span class="font-semibold text-slate-100">Step 6:</span> กด <span class="rounded bg-slate-800 px-1.5 py-0.5 text-xs">Save Selected ART</span> เพื่อบันทึกรูปโดยใช้ <code>game_id</code> เดียวกับที่ import</li>
        </ol>
        <p class="mt-3 text-xs text-amber-300">Note: หลัง import ชื่อไฟล์เกมจะเป็นรูปแบบ <code>${id}_${filename}</code> เพื่อให้ OPL map กับ ART ได้ตรง และระบบยังเก็บ mapping ใน <code>CFG/game_manifest.json</code>.</p>
      </section>

      <section class="mt-6 rounded-2xl border border-slate-800 bg-slate-900/80 p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-lg font-semibold text-slate-100">ART Manager</h2>
          <select id="art-mode" class="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100">
            <option value="manual">Manual Upload</option>
            <option value="auto" selected>Auto Fetch (RAWG)</option>
          </select>
        </div>

        <div class="mt-4 grid gap-4 md:grid-cols-2">
          <div>
            <label for="art-game-name" class="block text-sm font-medium text-slate-200">Game Name (optional)</label>
            <input id="art-game-name" type="text" placeholder="Resident Evil 4" class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100" />
          </div>
          <div>
            <label for="art-source-filename" class="block text-sm font-medium text-slate-200">ISO Filename (fallback)</label>
            <input id="art-source-filename" type="text" placeholder="SLUS_209.46_Resident_Evil_4.iso" class="mt-2 w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-100" />
          </div>
        </div>
        <p class="mt-2 text-xs text-slate-400">Generated Game ID: <span id="generated-game-id" class="font-semibold text-cyan-300">-</span></p>

        <div id="manual-art-block" class="mt-5 hidden space-y-3">
          <p class="text-sm text-slate-300">Upload files by art type.</p>
          <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
            <label class="text-xs text-slate-300">COV<input id="art-cov" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">COV2<input id="art-cov2" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">BG<input id="art-bg" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">SCR<input id="art-scr" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">SCR2<input id="art-scr2" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">LGO<input id="art-lgo" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">ICO<input id="art-ico" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
            <label class="text-xs text-slate-300">LAB<input id="art-lab" type="file" accept=".jpg,.jpeg,.png" class="mt-1 block w-full text-xs" /></label>
          </div>
          <button id="upload-manual-art-btn" type="button" class="rounded-lg bg-cyan-400 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-cyan-300">Upload Manual ART</button>
        </div>

        <div id="auto-art-block" class="mt-5">
          <div class="flex flex-wrap gap-3">
            <button id="search-auto-art-btn" type="button" class="rounded-lg bg-indigo-400 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-indigo-300">Search ART</button>
            <button id="save-auto-art-btn" type="button" class="rounded-lg bg-emerald-400 px-4 py-2 text-sm font-semibold text-slate-950 transition hover:bg-emerald-300">Save Selected ART</button>
          </div>
          <p class="mt-2 text-xs text-slate-400">Search uses RAWG API. Preview images below, assign art type, then save.</p>
          <div id="auto-art-results" class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
        </div>
      </section>
    </main>

    <div id="loading-overlay" class="pointer-events-none fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/70 backdrop-blur-sm">
      <div class="rounded-xl border border-cyan-500/40 bg-slate-900/95 px-6 py-5 text-center shadow-xl">
        <div class="mx-auto h-10 w-10 animate-spin rounded-full border-4 border-slate-700 border-t-cyan-400"></div>
        <p id="loading-text" class="mt-3 text-sm font-medium text-slate-100">Working...</p>
      </div>
    </div>

    <script src="/static/app.js"></script>
  </body>
</html>
